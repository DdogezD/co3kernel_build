From c2b12259a113ab576d7b76e38245ab22fdd64db6 Mon Sep 17 00:00:00 2001
From: Pzqqt <821026875@qq.com>
Date: Thu, 30 May 2024 21:31:45 +0800
Subject: [PATCH] crypto: zstd: Make the compression level can be modified in
 userspace

Signed-off-by: Pzqqt <821026875@qq.com>
---
 crypto/zstd.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/crypto/zstd.c b/crypto/zstd.c
index bc8111a5959d1..3da2a10e24999 100644
--- a/crypto/zstd.c
+++ b/crypto/zstd.c
@@ -15,7 +15,8 @@
 #include <crypto/internal/scompress.h>
 
 
-#define ZSTD_DEF_LEVEL	1
+static uint __read_mostly compression_level = 1;
+module_param(compression_level, uint, 0644);
 
 struct zstd_ctx {
 	zstd_cctx *cctx;
@@ -26,7 +27,11 @@ struct zstd_ctx {
 
 static zstd_parameters zstd_params(void)
 {
-	return zstd_get_params(ZSTD_DEF_LEVEL, PAGE_SIZE);
+	if (compression_level == 0)
+		compression_level = 1;
+	if (compression_level > zstd_max_clevel())
+		compression_level = zstd_max_clevel();
+	return zstd_get_params(compression_level, PAGE_SIZE);
 }
 
 static int zstd_comp_init(struct zstd_ctx *ctx)
