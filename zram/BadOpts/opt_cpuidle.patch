From 5db240ec79eca1c5992d5a2c17e81d60e6cab63f Mon Sep 17 00:00:00 2001
From: Sultan Alsawaf <sultan@kerneltoast.com>
Date: Sat, 2 Dec 2023 20:58:01 -0800
Subject: [PATCH] cpuidle: Reject idle entry if need_resched() is true

There's no reason to enter idle at this point in __CPU_PM_CPU_IDLE_ENTER()
if the CPU needs to reschedule. Instead of fruitlessly entering the
architecture's idle routine, reject the idle entry attempt with an error as
an optimization.

Signed-off-by: Sultan Alsawaf <sultan@kerneltoast.com>
---
 include/linux/cpuidle.h | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/include/linux/cpuidle.h b/include/linux/cpuidle.h
index 7d3b26a900a63..800b0d40b95d6 100644
--- a/include/linux/cpuidle.h
+++ b/include/linux/cpuidle.h
@@ -316,7 +316,9 @@ extern s64 cpuidle_governor_latency_req(unsigned int cpu);
 ({									\
 	int __ret = 0;							\
 									\
-	if (!idx) {							\
+	if (need_resched()) {						\
+		__ret = -1;						\
+	} else if (!idx) {						\
 		cpu_do_idle();						\
 		return idx;						\
 	}								\
